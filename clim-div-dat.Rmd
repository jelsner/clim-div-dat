---
title: "Climate Division Data"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r}
library(tidyverse)
```

https://data.nodc.noaa.gov/cgi-bin/iso?id=gov.noaa.ncdc:C00005#

```{r}
url <- "ftp://ftp.ncdc.noaa.gov/pub/data/cirs/climdiv/climdiv-tmpccy-v1.0.0-20190805"
df <- read.table(file = url,
                 colClasses = c("character", rep("numeric", times = 12)),
                 col.names = c("ID_Year", month.abb)) %>%
  transform(STID = substr(ID_Year, 1, 2),
            CTYID = substr(ID_Year, 3, 5),
            DataType = substr(ID_Year, 6, 7),
            Year = as.numeric(substr(ID_Year, 8, 11))) %>%
  select(STID, CTYID, Year, month.abb)
```

Leon County Florida is STID = 08, CTYID = 073 (see `county-readme.txt`).
```{r}
df <- df %>%
  filter(STID == "08", CTYID == "073") %>%
  filter(Year < 2019, Year >= 1940)
```

```{r}
ggplot(df, aes(x = Year, y = Feb)) +
  geom_point() +
  geom_smooth(method = lm)
```

```{r}
dfL <- df %>%
  select(Year, Jan, Feb, Mar, Apr, May, Jun, Jul, Aug, Sep, Oct, Nov, Dec) %>%
  gather(key = Year,
         value = "Variable",
         factor_key = TRUE) %>%
  rename(Month = Year) %>%
  mutate(Year = rep(1940:2018, times = 12))
head(dfL)
```

The `gather()` function takes all the values as measured except those named in `key =` argument. All variables are measured (precipitation in units of inches) except `Year`. `Year` is a vector identifying the month.

The long data frame lists the key variable names as the first column taking the column names as character strings starting with `Jan`. To preserve the order of the columns (e.g., January comes before February, etc) we specify the `factor_key = TRUE`. We use `rename()` to give the key variable the correct name.

```{r}
ggplot(dfL, aes(x = Year, y = Variable)) +
  geom_point() +
  geom_smooth(method = lm) +
  facet_wrap(~ Month)
```

Without the points and on a single graph.
```{r}
ggplot(dfL, aes(x = Year, y = Variable, color = Month)) +
  geom_smooth(method = lm)
```

Make this a slope graph.

First compute regressions for each month. Here I use the **broom** package.
```{r, eval=FALSE}
library(broom)

Trends <- dfL %>%
  group_by(Month) %>%
  do(tidy(lm(Variable ~ Year, data = .)))

Predictions <- dfL %>%
  group_by(Month) %>%
  do(tidy(predict(lm(Variable ~ Year, data = .), 
                  newdata = data.frame(Year = c(1940, 2018)))))
```

Try with the **purrr* package.
```{r}
library(reshape2)

Predictions <- dfL %>%
  split(.$Month) %>%  # base R
  map(~ lm(Variable ~ Year, data = .)) %>%
  map(predict, newdata = data.frame(Year = c(1940, 2018))) %>%
  as.data.frame() %>%
  mutate(Year = c("1940", "2018")) %>%
  mutate_if(is.numeric, ~round(., 1)) %>%
  melt(id.vars = "Year")
```

Get code from Chuck Powell: https://ibecav.github.io/CGPfunctions/reference/newggslopegraph.html
```{r}
library(CGPfunctions)

newggslopegraph(Predictions, Year, value, variable)
```

Better.
```{r}
newggslopegraph(Predictions, Year, value, variable,
                Title = "Trends in Monthly Average Temperatures (°F)",
                SubTitle = "Leon County, FL",
                LineColor = "gray50",
                Caption = "Data: NOAA, nCLIMDIV",
                LineThickness = .5,
                YTextSize = 3,
                DataLabelPadding = .05)

```

From scratch.
```{r}

MySpecial <- list(  
  # move the x axis labels up top
  scale_x_discrete(position = "top"),
  theme_bw(),
  # Format tweaks
  # Remove the legend
  theme(legend.position = "none"),
  # Remove the panel border
  theme(panel.border     = element_blank()),
  # Remove just about everything from the y axis
  theme(axis.title.y     = element_blank()),
  theme(axis.text.y      = element_blank()),
  theme(panel.grid.major.y = element_blank()),
  theme(panel.grid.minor.y = element_blank()),
  # Remove a few things from the x axis and increase font size
  theme(axis.title.x     = element_blank()),
  theme(panel.grid.major.x = element_blank()),
  theme(axis.text.x.top      = element_text(size=12)),
  # Remove x & y tick marks
  theme(axis.ticks       = element_blank()),
  # Format title & subtitle
  theme(plot.title       = element_text(size=14, face = "bold", hjust = 0.5)),
  theme(plot.subtitle    = element_text(hjust = 0.5))
)

library(ggrepel)

ggplot(data = Predictions, aes(x = Year, y = value, group = variable)) +
  geom_line(color = "gray", size = 1) +
  geom_text_repel(data = Predictions %>% filter(Year == "1940"), 
                  aes(label = variable) , 
                  hjust = "left", 
                  fontface = "bold", 
                  size = 3, 
                  nudge_x = -.45, 
                  direction = "y") +
  geom_text_repel(data = Predictions %>% filter(Year == "2018"), 
                  aes(label = variable) , 
                  hjust = "right", 
                  fontface = "bold", 
                  size = 3, 
                  nudge_x = .5, 
                  direction = "y") +
  geom_label(aes(label = value), 
             size = 2.5, 
             label.padding = unit(0.05, "lines"), 
             label.size = 0.0) +
  MySpecial +
  labs(
    title = "Trends in Monthly Average Temperatures (°F",
    subtitle = "Leon County, FL",
    caption = "Data: NOAA, nCLIMDIV"
  )
```
